<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Status Pesanan ‚Äî Arufkuy Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            glow: "0 0 0 1px rgba(148,163,184,.12), 0 12px 40px rgba(2,6,23,.55)"
          }
        }
      }
    }
  </script>
  <style>
    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 1;
      }

      100% {
        transform: scale(1.6);
        opacity: 0;
      }
    }

    @keyframes fade-up {
      from {
        opacity: 0;
        transform: translateY(16px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-pulse-ring {
      animation: pulse-ring 2s ease-out infinite;
    }

    .animate-fade-up {
      animation: fade-up 0.5s ease-out both;
    }

    .delay-100 {
      animation-delay: 0.1s;
    }

    .delay-200 {
      animation-delay: 0.2s;
    }

    .delay-300 {
      animation-delay: 0.3s;
    }

    .delay-400 {
      animation-delay: 0.4s;
    }

    .delay-500 {
      animation-delay: 0.5s;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.3);
      border-radius: 99px;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    details summary {
      list-style: none;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100 font-sans flex justify-center p-4 lg:p-8">

  <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 items-start">

    <!-- ==================== LEFT COLUMN (Status & Info) ==================== -->
    <div class="space-y-6 animate-fade-up lg:sticky lg:top-8 lg:h-fit">

      <!-- 1. Status Header -->
      <div id="status-header"
        class="text-center lg:text-left bg-white/[0.03] backdrop-blur-sm border border-white/10 rounded-3xl p-6 lg:p-8 shadow-glow flex flex-col lg:flex-row items-center gap-6">
        <!-- Animated Icon -->
        <div class="relative w-20 h-20 shrink-0">
          <div id="status-ring" class="absolute inset-0 rounded-full bg-emerald-500/20 animate-pulse-ring"></div>
          <div id="status-icon"
            class="relative grid h-20 w-20 place-items-center rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        </div>
        <div class="text-center lg:text-left">
          <h1 id="status-title-text" class="text-2xl font-bold tracking-tight" data-i18n="status_title">Memuat...</h1>
          <p id="status-desc-text" class="mt-2 text-sm text-slate-400" data-i18n="status_desc">Sedang
            memuat data pesanan Anda...</p>
        </div>
      </div>

      <!-- 2. Order Info Section -->
      <div
        class="rounded-3xl border border-white/10 bg-white/[0.03] backdrop-blur-sm shadow-glow p-6 space-y-3 delay-100">
        <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Informasi Pesanan</h2>

        <!-- Order ID -->
        <div class="flex items-center justify-between rounded-2xl border border-white/10 bg-slate-900/50 px-4 py-3">
          <div>
            <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">Order ID</p>
            <p id="ref-id" class="font-mono font-bold text-white text-sm tracking-wider mt-0.5">...</p>
          </div>
          <button onclick="copyText(document.getElementById('ref-id').textContent, this)"
            class="text-slate-500 hover:text-emerald-400 transition p-1.5 rounded-lg hover:bg-white/5" title="Salin">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
              <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
            </svg>
          </button>
        </div>

        <!-- Product & Price Row -->
        <div class="grid grid-cols-2 gap-3">
          <div class="rounded-2xl border border-white/10 bg-slate-900/50 px-4 py-3">
            <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">Produk</p>
            <p id="product-name" class="font-semibold text-white text-sm mt-0.5 truncate">...</p>
          </div>
          <div class="rounded-2xl border border-white/10 bg-slate-900/50 px-4 py-3">
            <p class="text-[10px] text-slate-500 uppercase tracking-wider font-semibold">Total</p>
            <p id="product-price" class="font-bold text-emerald-400 text-sm mt-0.5">...</p>
          </div>
        </div>
      </div>

      <!-- 3. Support Info Box -->
      <div class="p-6 rounded-3xl border border-white/10 bg-white/[0.03] backdrop-blur-sm shadow-glow delay-200">
        <div class="flex items-start gap-3 mb-4">
          <div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-400 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                clip-rule="evenodd" />
            </svg>
          </div>
          <div>
            <h3 class="text-sm font-bold text-slate-200 mb-1">Butuh Bantuan?</h3>
            <p class="text-xs text-slate-400 leading-relaxed" data-i18n="status_info_desc">
              Produk digital Anda akan ditampilkan di kolom sebelah kanan. Jika ada kendala, hubungi kami.
            </p>
          </div>
        </div>

        <!-- Support Buttons -->
        <div class="grid grid-cols-2 gap-3">
          <a href="https://tawk.to/chat/698a62f02fb5be1c3a2b2e1e/1jh294vin" target="_blank"
            class="flex items-center justify-center gap-2 py-2.5 px-4 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 text-xs font-semibold border border-emerald-500/20 transition group">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-75 group-hover:opacity-100 transition"
              viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                clip-rule="evenodd" />
            </svg>
            Live Chat
          </a>
          <a href="https://discord.gg/3sDGqtZBcW" target="_blank"
            class="flex items-center justify-center gap-2 py-2.5 px-4 rounded-xl bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 text-xs font-semibold border border-indigo-500/20 transition group">
            <svg class="w-4 h-4 opacity-75 group-hover:opacity-100 transition" fill="currentColor" viewBox="0 0 24 24">
              <!-- Simple Discord Icon Path -->
              <path
                d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z" />
            </svg>
            Discord
          </a>
        </div>
      </div>

    </div>

    <!-- ==================== RIGHT COLUMN (Deliveries & Actions) ==================== -->
    <div class="space-y-6 animate-fade-up delay-300">

      <!-- 4. Delivered Items Section -->
      <div id="delivered-items-section"
        class="rounded-3xl border border-white/10 bg-white/[0.03] backdrop-blur-sm shadow-glow overflow-hidden flex flex-col min-h-[300px] max-h-[500px]">
        <div class="p-6 border-b border-white/5 bg-white/[0.02] flex items-center justify-between shrink-0">
          <div class="flex items-center gap-2">
            <div class="h-5 w-5 rounded-full bg-emerald-500/20 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-emerald-400" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM9 8H4v2h5V8z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <h2 class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Delivered Items</h2>
          </div>
        </div>

        <div class="p-6 flex-1 relative overflow-y-auto custom-scrollbar">
          <!-- Placeholder (shown when no items yet) -->
          <div id="delivered-items-placeholder"
            class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
            <div class="mx-auto w-12 h-12 rounded-full bg-slate-800 grid place-items-center mb-4 border border-white/5">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <p id="placeholder-title" class="text-sm text-slate-200 font-medium">Menunggu Proses</p>
            <p id="placeholder-desc" class="text-xs text-slate-500 mt-2 max-w-xs">Produk digital Anda akan otomatis
              dikirim setelah
              pembayaran dikonfirmasi. Halaman ini akan otomatis terupdate.</p>
          </div>

          <!-- Items List (populated by JS) -->
          <div id="delivered-items-list" class="space-y-3 hidden relative z-10 pb-2"></div>
        </div>
      </div>

      <!-- 5. Buyer Notes Section (hidden by default) -->
      <div id="buyer-notes-section" class="hidden rounded-3xl border border-amber-500/20 bg-amber-950/10 p-6">
        <div class="flex items-center gap-2 mb-3">
          <div class="h-5 w-5 rounded-full bg-amber-500/20 grid place-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-amber-400" viewBox="0 0 20 20"
              fill="currentColor">
              <path
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" />
            </svg>
          </div>
          <h2 class="text-xs font-bold text-amber-400 uppercase tracking-widest">Catatan Admin</h2>
        </div>
        <div class="rounded-2xl border border-amber-500/10 bg-amber-500/5 px-4 py-3">
          <p id="buyer-notes-text" class="text-sm text-amber-200 whitespace-pre-wrap leading-relaxed"></p>
        </div>
      </div>

      <!-- 6. Footer Actions -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="index.html"
          class="flex w-full justify-center items-center gap-2 rounded-2xl bg-white/[0.07] hover:bg-white/[0.12] py-4 text-sm font-semibold text-white transition border border-white/5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path
              d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
          </svg>
          <span data-i18n="btn_home">Kembali ke Beranda</span>
        </a>
        <button onclick="viewInvoice()"
          class="flex w-full justify-center items-center gap-2 rounded-2xl bg-indigo-500/10 hover:bg-indigo-500/20 py-4 text-sm font-semibold text-indigo-400 transition border border-indigo-500/20"
          data-i18n="btn_invoice">
          Lihat Invoice
        </button>
      </div>

      <!-- Branding -->
      <p class="text-center text-[10px] text-slate-600 mt-4 lg:hidden">Arufkuy Store &copy; 2024</p>

    </div>

  </div>

  <!-- Simple encryption/decryption for local storage (optional) -->
  <script src="utils.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtBSbjr5IHmuZqND0MIexw-tWWcZIF33A",
      authDomain: "arufkuy-store.firebaseapp.com",
      projectId: "arufkuy-store",
      storageBucket: "arufkuy-store.firebasestorage.app",
      messagingSenderId: "694416486376",
      appId: "1:694416486376:web:fa36cccffd65557ddc3e5d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const orderId = params.get("orderId");
    // Mayar sends ?id=...&status=...
    // We treat 'id' as 'invoice' because we set redirectUrl to generic page
    const invoiceParam = params.get("invoice") || params.get("id");
    let refId = params.get("ref"); // Invoice ID from Mayar (legacy)
    const optionalRefId = params.get("refId"); // Optional refId from URL

    // Check if refId is a placeholder and treat it as invalid
    if (refId === '{invoiceId}' || refId === null || refId === '') {
      refId = null;
    }

    // Fallback for legacy URL (without orderId)
    const legacyProduct = params.get("product");
    const legacyPrice = params.get("price");

    // Global copy utility
    window.copyText = function (text, btn) {
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        // Brief visual feedback
        if (btn) {
          const originalHTML = btn.innerHTML;
          // Updated Checkmark - Brighter and properly centered
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>';
          // Add a small pulse effect class if desired, or just wait
          btn.classList.add("bg-emerald-500/10", "border-emerald-500/20");
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove("bg-emerald-500/10", "border-emerald-500/20");
          }, 2000);
        }
      });
    };

    if (orderId) {
      loadOrder(orderId);
    } else if (invoiceParam) {
      resolveInvoice(invoiceParam);
    } else if (legacyProduct) {
      // Legacy mode (just display from URL)
      document.getElementById("ref-id").textContent = refId || "-";
      document.getElementById("product-name").textContent = legacyProduct;
      document.getElementById("product-price").textContent = "Rp " + new Intl.NumberFormat("id-ID").format(legacyPrice);
      setStatus('paid', false);
    } else {
      setStatus('not-found');
    }

    function setStatus(status, hasItems) {
      const icon = document.getElementById("status-icon");
      const ring = document.getElementById("status-ring");
      const title = document.getElementById("status-title-text");
      const desc = document.getElementById("status-desc-text");
      const placeholderTitle = document.getElementById("placeholder-title");
      const placeholderDesc = document.getElementById("placeholder-desc");

      if (status === 'paid' || status === 'completed') {
        icon.className = "relative grid h-20 w-20 place-items-center rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30";
        ring.className = "absolute inset-0 rounded-full bg-emerald-500/20 animate-pulse-ring";
        icon.innerHTML = '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';

        if (hasItems) {
          if (title) title.textContent = "Pembayaran Berhasil";
          if (desc) desc.textContent = "Terima kasih! Produk digital Anda sudah dikirim.";
        } else {
          if (title) title.textContent = "Pembayaran Diterima";
          if (desc) desc.textContent = "Pembayaran berhasil! Produk Anda sedang diproses, halaman ini akan otomatis terupdate.";
          if (placeholderTitle) placeholderTitle.textContent = "Sedang Memproses";
          if (placeholderDesc) placeholderDesc.textContent = "Pembayaran dikonfirmasi. Produk digital Anda sedang diproses dan akan segera muncul di sini.";
        }
      } else if (status === 'pending') {
        icon.className = "relative grid h-20 w-20 place-items-center rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30";
        ring.className = "absolute inset-0 rounded-full bg-amber-500/20 animate-pulse-ring";
        icon.innerHTML = '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        if (title) title.textContent = "Menunggu Pembayaran";
        if (desc) desc.textContent = "Silakan selesaikan pembayaran Anda. Setelah bayar, produk akan otomatis dikirim.";
        if (placeholderTitle) placeholderTitle.textContent = "Menunggu Pembayaran";
        if (placeholderDesc) placeholderDesc.textContent = "Produk digital Anda akan otomatis dikirim setelah pembayaran dikonfirmasi. Halaman ini akan otomatis terupdate.";
      } else if (status === 'not-found') {
        icon.className = "relative grid h-20 w-20 place-items-center rounded-full bg-red-500/20 text-red-400 border border-red-500/30";
        ring.className = "absolute inset-0 rounded-full bg-red-500/20";
        ring.style.animation = 'none';
        icon.innerHTML = '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
        if (title) title.textContent = "Pesanan Tidak Ditemukan";
        if (desc) desc.textContent = "Mohon periksa kembali link Anda.";
      } else {
        if (title) title.textContent = "Status: " + status;
      }
    }

    async function resolveInvoice(invoice) {
      try {
        console.log("Resolving invoice:", invoice);
        // Find order by invoiceId
        const q = query(collection(db, "orders"), where("invoiceId", "==", invoice), limit(1));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          const docSnap = querySnapshot.docs[0];
          const realOrderId = docSnap.id;
          console.log("Found orderId:", realOrderId);
          loadOrder(realOrderId);
        } else {
          console.warn('Invoice not found:', invoice);
          setStatus('not-found');
        }
      } catch (error) {
        console.error('Error finding invoice:', error);
        setStatus('not-found');
      }
    }

    function loadOrder(id) {
      let pollInterval = null;

      // Start auto-polling as fallback (will be cleared once realtime works)
      function startPolling() {
        if (pollInterval) return; // Already polling
        console.log('Starting auto-poll fallback every 5 seconds...');
        pollInterval = setInterval(async () => {
          try {
            const docSnap = await getDoc(doc(db, "orders", id));
            if (docSnap.exists()) {
              processOrderData(docSnap.data());
            }
          } catch (e) {
            console.warn('Poll error:', e.code || e.message);
          }
        }, 5000);
      }

      function processOrderData(data) {
        console.log("Order Data Loaded:", data); // DEBUG

        // FEATURE: URL Masquerading
        // If we loaded via orderId but have an invoiceId, switch URL to use invoice
        // This makes the link shareable and hides the internal orderId
        if (data.invoiceId) {
          const currentUrl = new URL(window.location);
          if (currentUrl.searchParams.has("orderId")) {
            currentUrl.searchParams.delete("orderId");
            currentUrl.searchParams.set("invoice", data.invoiceId);
            window.history.replaceState({}, '', currentUrl);
            // Update params specific variables if needed, though page is already loading
          }
        }

        const displayRefId = data.invoiceId || refId || id;
        document.getElementById("ref-id").textContent = displayRefId;
        document.getElementById("product-name").textContent = data.productName;
        document.getElementById("product-price").textContent = "Rp " + new Intl.NumberFormat("id-ID").format(data.totalPrice);

        const itemsToRender = data.deliveredItems || data.stockItems;
        const hasItems = Array.isArray(itemsToRender) && itemsToRender.length > 0;

        // Update Status UI with item awareness
        setStatus(data.status, hasItems);

        if (data.status === 'paid' || data.status === 'completed') {
          if (hasItems) {
            renderDeliveredItems(itemsToRender);
            // Items delivered ‚Äî stop polling
            if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
          }

          if (data.buyerNotes) {
            renderBuyerNotes(data.buyerNotes);
          }
        }
      }

      // Try real-time listener first
      onSnapshot(doc(db, "orders", id), (docSnap) => {
        if (docSnap.exists()) {
          processOrderData(docSnap.data());
        } else {
          setStatus('not-found');
        }
      }, (error) => {
        console.warn("Realtime listener error:", error.code);

        // Fallback: one-time fetch + start polling
        getDoc(doc(db, "orders", id)).then((docSnap) => {
          if (docSnap.exists()) {
            processOrderData(docSnap.data());
            // If still pending, start polling
            const data = docSnap.data();
            if (data.status === 'pending' || (data.status === 'paid' && !data.deliveredItems)) {
              startPolling();
            }
          } else {
            setStatus('not-found');
          }
        }).catch(() => {
          setStatus('not-found');
        });
      });
    }

    function renderDeliveredItems(items) {
      const placeholder = document.getElementById("delivered-items-placeholder");
      const list = document.getElementById("delivered-items-list");

      // Normalize items to array
      let itemsArray = [];
      if (Array.isArray(items)) {
        itemsArray = items.map(item => {
          if (typeof item === 'string') {
            return { content: item, note: '' };
          }
          return item;
        });
      } else if (items) {
        if (typeof items === 'string') {
          itemsArray = [{ content: items, note: '' }];
        } else {
          itemsArray = [items];
        }
      }

      if (itemsArray.length === 0) return;

      // Hide placeholder, show list
      placeholder.classList.add("hidden");
      list.classList.remove("hidden");
      list.innerHTML = "";

      // Render Items using User's Preferred Style (Split Multi-line)
      itemsArray.forEach((item, index) => {
        const details = document.createElement("details");
        details.className = "group bg-slate-950/30 rounded-xl border border-white/5 overflow-hidden";
        if (index === 0) details.open = true;

        // 1. Process Content: Split by Newline
        const contentLines = (item.content || '').split(/\r?\n/).filter(line => line.trim() !== '');

        let contentHtml = '';
        if (contentLines.length > 0) {
          contentHtml = contentLines.map(line => `
              <div class="bg-black/40 rounded-lg p-3 border border-emerald-500/10 relative group/copy mb-2 last:mb-0">
                <div class="font-mono text-sm text-emerald-300 break-all whitespace-pre-wrap select-all font-medium pr-8 leading-relaxed">${line}</div>
                <button onclick="copyText(this.previousElementSibling.innerText, this)" class="absolute top-2 right-2 text-slate-600 hover:text-emerald-400 bg-slate-800/50 hover:bg-slate-800 p-1.5 rounded-lg transition border border-white/5">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                  </svg>
                </button>
              </div>
            `).join('');
        } else {
          // Fallback for empty content
          contentHtml = `<div class="text-slate-500 italic text-xs">Konten tidak tersedia</div>`;
        }

        // 2. Note HTML
        let noteHtml = '';
        if (item.note) {
          noteHtml = `
            <div class="mt-3 flex items-start gap-2 p-3 rounded-lg bg-amber-500/5 border border-amber-500/10">
               <span class="text-amber-400 text-sm">üìù</span>
               <div class="text-xs text-amber-200/80 italic leading-relaxed whitespace-pre-wrap font-sans">${item.note}</div>
            </div>
          `;
        }

        details.innerHTML = `
            <summary class="flex justify-between items-center p-4 cursor-pointer select-none bg-white/[0.02] hover:bg-white/[0.04] transition sticky top-0 backdrop-blur-md z-10">
                <div class="flex items-center gap-3">
                    <div class="h-6 w-6 rounded-full bg-emerald-500/10 border border-emerald-500/20 grid place-items-center text-xs font-bold text-emerald-400 font-mono">${index + 1}</div>
                    <span class="text-sm font-medium text-slate-300 group-open:text-white transition">Item #${index + 1}</span>
                </div>
                <span class="text-slate-500 transition-transform duration-300 group-open:rotate-180">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </span>
            </summary>
            <div class="p-4 border-t border-white/5 bg-black/20">
              ${contentHtml}
              ${noteHtml}
            </div>
          `;
        list.appendChild(details);
      });
    }

    function renderBuyerNotes(notes) {
      const section = document.getElementById("buyer-notes-section");
      const text = document.getElementById("buyer-notes-text");
      section.classList.remove("hidden");
      text.textContent = notes;
    }

    function viewInvoice() {
      // Try to get invoiceId from displayed ref-id
      const displayedRef = document.getElementById("ref-id").textContent;
      const invoiceId = displayedRef && displayedRef !== '...' && displayedRef !== '-' ? displayedRef : refId;

      if (invoiceId) {
        window.location.href = `https://arufkuy.myr.id/invoices/${invoiceId}`;
      } else {
        alert("Invoice ID belum tersedia.");
      }
    }

    // Expose function to global scope for onclick
    window.viewInvoice = viewInvoice;
  </script>
</body>


</html>